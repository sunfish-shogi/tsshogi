import { Record, exportKIF, importKIF, exportJKF, importJKFString } from "../";
import * as fs from "node:fs";

describe("shogi/jkf", () => {
  it("importJKF", () => {
    const testCases = [
      {
        testData: "src/tests/testdata/jkf/sample01.jkf",
        expected: `# KIF形式棋譜ファイル Generated by Electron Shogi
開始日時：2023/08/01 10:30:00
表題：テスト対局
棋戦：ユニットテスト選手権
戦型：居飛車
持ち時間：一億年
場所：ラップトップ
掲載：GitHub
先手：ルノワール
後手：ゴッホ
備考：テスト
手合割：平手
手数----指手---------消費時間--
*【コメントのテスト】
*
*この上に空行があります。
*この行の上下に空行はありません。
*この行の下に空行があります。
   1 ２六歩(27)   ( 0:00/00:00:00)
*1手目のコメントです。
   2 ８四歩(83)   ( 0:00/00:00:00)
*2手目のコメントです。
`,
      },
      {
        testData: "src/tests/testdata/jkf/sample02.jkf",
        expected: `# KIF形式棋譜ファイル Generated by Electron Shogi
後手の持駒：なし
  ９ ８ ７ ６ ５ ４ ３ ２ １
+---------------------------+
|v香v桂v銀v金v玉 ・v銀v桂v香|一
| ・v飛 ・ ・ ・ ・v金v角 ・|二
|v歩 ・v歩v歩v歩v歩v歩v歩v歩|三
| ・ ・ ・ ・ ・ ・ ・ ・ ・|四
| ・v歩 ・ ・ ・ ・ ・ 歩 ・|五
| ・ ・ ・ ・ ・ ・ ・ ・ ・|六
| 歩 歩 歩 歩 歩 歩 歩 ・ 歩|七
| ・ 角 金 玉 ・ ・ ・ 飛 ・|八
| 香 桂 銀 ・ ・ 金 銀 桂 香|九
+---------------------------+
先手の持駒：なし
後手番
手数----指手---------消費時間--
`,
      },
      {
        testData: "src/tests/testdata/jkf/sample03.jkf",
        expected: `# KIF形式棋譜ファイル Generated by Electron Shogi
手合割：平手
手数----指手---------消費時間--
   1 ２六歩(27)   ( 0:00/00:00:00)
   2 ８四歩(83)   ( 0:00/00:00:00)
   3 ２五歩(26)   ( 0:00/00:00:00)
   4 ８五歩(84)   ( 0:00/00:00:00)
   5 ７八金(69)   ( 0:00/00:00:00)
   6 ３二金(41)   ( 0:00/00:00:00)
   7 ３八銀(39)   ( 0:00/00:00:00)
   8 ７二銀(71)   ( 0:00/00:00:00)
   9 ５八玉(59)   ( 0:00/00:00:00)+
  10 ５二玉(51)   ( 0:00/00:00:00)+
  11 ７六歩(77)   ( 0:00/00:00:00)
  12 ８六歩(85)   ( 0:00/00:00:00)
  13 同　歩(87)   ( 0:00/00:00:00)
  14 同　飛(82)   ( 0:00/00:00:00)
  15 ２四歩(25)   ( 0:00/00:00:00)
  16 同　歩(23)   ( 0:00/00:00:00)
  17 同　飛(28)   ( 0:00/00:00:00)
  18 ２三歩打     ( 0:00/00:00:00)
  19 ２六飛(24)   ( 0:00/00:00:00)
  20 ３四歩(33)   ( 0:00/00:00:00)
  21 ８七歩打     ( 0:00/00:00:00)
  22 ８四飛(86)   ( 0:00/00:00:00)
  23 ３六歩(37)   ( 0:00/00:00:00)
  24 ７四歩(73)   ( 0:00/00:00:00)
  25 ２四歩打     ( 0:00/00:00:00)
  26 同　歩(23)   ( 0:00/00:00:00)
  27 同　飛(26)   ( 0:00/00:00:00)
  28 ７五歩(74)   ( 0:00/00:00:00)
  29 同　歩(76)   ( 0:00/00:00:00)
  30 ２三歩打     ( 0:00/00:00:00)
  31 ２五飛(24)   ( 0:00/00:00:00)

変化：10手
  10 ９四歩(93)   ( 0:00/00:00:00)

変化：9手
   9 ６八玉(59)   ( 0:00/00:00:00)+
  10 ５二玉(51)   ( 0:00/00:00:00)
  11 ３六歩(37)   ( 0:00/00:00:00)
  12 ８六歩(85)   ( 0:00/00:00:00)
  13 同　歩(87)   ( 0:00/00:00:00)
  14 同　飛(82)   ( 0:00/00:00:00)
  15 ７六歩(77)   ( 0:00/00:00:00)

変化：9手
   9 ９六歩(97)   ( 0:00/00:00:00)
  10 ９四歩(93)   ( 0:00/00:00:00)
  11 ３六歩(37)   ( 0:00/00:00:00)
  12 ８六歩(85)   ( 0:00/00:00:00)
  13 同　歩(87)   ( 0:00/00:00:00)
  14 同　飛(82)   ( 0:00/00:00:00)
  15 ３七銀(38)   ( 0:00/00:00:00)
  16 ３四歩(33)   ( 0:00/00:00:00)
  17 ８七歩打     ( 0:00/00:00:00)
  18 ８五飛(86)   ( 0:00/00:00:00)
  19 ２四歩(25)   ( 0:00/00:00:00)
  20 同　歩(23)   ( 0:00/00:00:00)
  21 同　飛(28)   ( 0:00/00:00:00)
  22 ２三歩打     ( 0:00/00:00:00)
  23 ２八飛(24)   ( 0:00/00:00:00)
  24 ５二玉(51)   ( 0:00/00:00:00)
  25 ６九玉(59)   ( 0:00/00:00:00)
  26 ７四歩(73)   ( 0:00/00:00:00)
  27 ７六歩(77)   ( 0:00/00:00:00)
`,
      },
      {
        testData: "src/tests/testdata/jkf/sample04.jkf",
        expected: `# KIF形式棋譜ファイル Generated by Electron Shogi
先手：Sunfish4 v0.1.2 - depth15
後手：Lesserkai 1.5.0
対局日：2023/08/18
開始日時：2023/08/18 23:36:03
持ち時間： 0:00+10
終了日時：2023/08/18 23:37:01
手合割：平手
手数----指手---------消費時間--
   1 ２六歩(27)   ( 0:00/00:00:00)
   2 ３四歩(33)   ( 0:00/00:00:00)
   3 ２五歩(26)   ( 0:00/00:00:00)
   4 ３三角(22)   ( 0:00/00:00:00)
   5 ７六歩(77)   ( 0:00/00:00:00)
   6 ４四歩(43)   ( 0:00/00:00:00)
   7 ４八銀(39)   ( 0:00/00:00:00)
   8 ４二銀(31)   ( 0:00/00:00:00)
   9 ５六歩(57)   ( 0:00/00:00:00)
  10 ５四歩(53)   ( 0:00/00:00:00)
  11 ６八玉(59)   ( 0:00/00:00:00)
*互角
**評価値=159
**読み筋=△６二銀▲７八玉△４三銀▲６八銀△３二金▲７七銀△４一玉▲７九角△３一玉▲３六歩△４二角▲５八金右△７四歩▲３七銀
**深さ=15
  12 ４三銀(42)   ( 0:00/00:00:00)
  13 ７八玉(68)   ( 0:00/00:00:00)
*互角
**評価値=146
**読み筋=△６二銀▲６八銀△３二金▲７七銀△４一玉▲７九角△３一玉▲３六歩△４二角▲３七銀△７四歩▲５八金右△７五歩▲同　歩△同　角
**深さ=15
  14 ５二飛(82)   ( 0:00/00:00:00)
  15 ５七銀(48)   ( 0:00/00:00:00)
*先手有望
**評価値=269
**読み筋=△６二銀▲６八銀上△５三銀▲６六歩△６二玉▲６七銀△７二玉▲７七角△６四銀▲５八金右△８二玉▲８八玉△５五歩▲同　歩△同　銀
**深さ=15
  16 ６二玉(51)   ( 0:00/00:00:00)
*互角
**評価値=3
**読み筋=▲５八金右△３二金▲６八銀上
  17 ７七角(88)   ( 0:00/00:00:00)
*先手有望
**評価値=314
**読み筋=△７二玉▲８八玉△４五歩▲６六銀△８二玉▲９八香△６四歩▲５八金右△６五歩▲同　銀△７七角成▲同　桂△７二銀▲２四歩△同　歩▲同　飛
**深さ=15
  18 ３二金(41)   ( 0:00/00:00:00)
*互角
**評価値=-10
**読み筋=▲５八金右△７二金▲６八銀上
  19 ８八玉(78)   ( 0:00/00:00:00)
*先手有利
**評価値=456
**読み筋=△４五歩▲６六銀△７二玉▲９八香△６四歩▲９九玉△６五歩▲同　銀△７七角成▲同　桂△５七角▲８八銀△３三桂▲６四銀△６二銀
**深さ=15
  20 ７二金(61)   ( 0:00/00:00:00)
*互角
**評価値=-13
**読み筋=▲５八金右△３五歩▲６八銀上
  21 ９八香(99)   ( 0:00/00:00:00)
*先手優勢
**評価値=709
**読み筋=△６四歩▲９九玉△６三玉▲８八銀△６二銀▲６六銀△７四歩▲７九金△５一飛▲５九金△７三桂▲６九金右△６五歩▲５七銀
**深さ=15
  22 ６一玉(62)   ( 0:00/00:00:00)
*互角
**評価値=-16
**読み筋=▲５八金右△６二銀▲６八銀上
  23 ９九玉(88)   ( 0:00/00:00:00)
*先手優勢
**評価値=831
**読み筋=△６二銀▲８八銀△７一玉▲７九金△５一飛▲５九金△４二角▲６九金右△９四歩▲６六銀△８二玉▲７八金右△９五歩▲６八角
**深さ=15
  24 ６二銀(71)   ( 0:00/00:00:00)
*互角
**評価値=-15
**読み筋=▲５八金右△３五歩▲６八銀上
  25 ８八銀(79)   ( 0:00/00:00:00)
*先手優勢
**評価値=762
**読み筋=△５一飛▲７九金△７四歩▲６六銀△４二角▲５九金△５二玉▲６八角△７三桂▲６九金右△８一飛▲７八金右△６四角▲２四歩△同　歩▲同　飛
**深さ=15
  26 ７一玉(61)   ( 0:00/00:00:00)
*互角
**評価値=-19
**読み筋=▲５八金右△８二玉▲７五歩
  27 ５九金(49)   ( 0:00/00:00:00)
*先手優勢
**評価値=810
**読み筋=△４五歩▲６六銀△６四歩▲６八金右△８二玉▲７八金寄△５一飛▲７九金寄△６五歩▲同　銀△７七角成▲同　金△５七角▲６四銀△３九角成
**深さ=15
  28 ８二玉(71)   ( 0:00/00:00:00)
*互角
**評価値=-21
**読み筋=▲５八金直△３五歩▲７五歩
  29 ７九金(69)   ( 0:00/00:00:00)
*先手優勢
**評価値=783
**読み筋=△６四歩▲６六銀△５一飛▲６九金右△６三銀▲７八金右△９四歩▲６八角△９五歩▲３六歩△７四歩▲２四歩△同　歩▲同　角△７三桂
**深さ=15
  30 ６四歩(63)   ( 0:00/00:00:00)
*互角
**評価値=-25
**読み筋=▲５八金△６三銀▲６八金上
  31 ６八金(59)   ( 0:00/00:00:00)
*先手優勢
**評価値=770
**読み筋=△６五歩▲６六歩△５五歩▲同　歩△同　飛▲６五歩△同　飛▲７八金寄△６三飛▲３六歩△５二銀▲８六角△５一歩▲６四歩△５三飛
**深さ=15
  32 ６三銀(62)   ( 0:00/00:00:00)
*互角
**評価値=-27
**読み筋=▲６九金寄△６五歩▲７五歩
  33 ６六銀(57)   ( 0:00/00:00:00)
*先手優勢
**評価値=691
**読み筋=△７四歩▲７八金寄△６五歩▲同　銀△７三桂▲６六歩△４二角▲９五角△５一飛▲７三角成△同　金▲７五歩△同　角▲８五桂△６六角▲７三桂成△同　玉
**深さ=15
  34 ３五歩(34)   ( 0:00/00:00:00)
*互角
**評価値=-31
**読み筋=▲５七銀△６五歩▲６九金寄
  35 ７八金(68)   ( 0:00/00:00:00)
*先手優勢
**評価値=780
**読み筋=△３四銀▲８六角△５一飛▲７五銀△４二角▲６八角△４三金▲６六銀△９四歩▲２六飛△９五歩▲３六歩△同　歩▲同　飛△３三角
**深さ=15
  36 ４五歩(44)   ( 0:00/00:00:00)
*互角
**評価値=-42
**読み筋=▲６八金寄△１四歩▲５七銀
  37 ６八角(77)   ( 0:00/00:00:00)
*先手優勢
**評価値=812
**読み筋=△３四銀▲３八飛△４三金▲３六歩△同　歩▲同　飛△２五銀▲３八飛△６五歩▲同　銀△６四歩▲２八飛△３四金▲３七桂△４四角▲２五桂△６五歩
**深さ=15
  38 ４四銀(43)   ( 0:00/00:00:00)
*互角
**評価値=-25
**読み筋=▲６九金△１四歩▲５七銀
  39 ９六歩(97)   ( 0:00/00:00:00)
*先手優勢
**評価値=794
**読み筋=△９四歩▲２六飛△１五角▲１六飛△３三角▲４六歩△同　歩▲同　飛△５一飛▲２六飛△７四歩▲１六歩△５五歩▲同　歩△同　銀
**深さ=15
  40 １四歩(13)   ( 0:00/00:00:00)
*互角
**評価値=-26
**読み筋=▲６九金△１五歩▲５七銀
  41 ９五歩(96)   ( 0:00/00:00:00)
*先手優勢
**評価値=849
**読み筋=△７四歩▲７五歩△同　歩▲同　銀△７四歩▲６六銀△４三金▲２六飛△７三桂▲７五歩△同　歩▲同　銀△７四歩▲８六銀△５五歩▲同　歩△同　飛
**深さ=15
  42 １五歩(14)   ( 0:00/00:00:00)
*互角
**評価値=-25
**読み筋=▲６九金△７四歩▲５七銀
  43 ３六歩(37)   ( 0:00/00:00:00)
*先手優勢
**評価値=952
**読み筋=△３六歩▲２四歩△同　歩▲同　角△５一飛▲６八角△７四歩▲２五飛△２三歩▲２八飛△５五歩▲３四歩△２二角▲５五歩△同　銀
**深さ=15
  44 同　歩(35)   ( 0:00/00:00:00)
*後手有望
**評価値=-251
**読み筋=▲２六飛△１三桂▲５七銀
  45 ２四歩(25)   ( 0:00/00:00:00)
*先手優勢
**評価値=966
**読み筋=△２四歩▲同　角△５一飛▲６八角△７四歩▲４六歩△６五歩▲同　銀△６四歩▲３四歩△４二角▲４五歩△同　銀▲４三歩△同　金
**深さ=15
  46 ３七歩成(36) ( 0:00/00:00:00)
*後手優勢
**評価値=-1184
**読み筋=▲３七桂△３六歩▲２七飛
  47 同　桂(29)   ( 0:00/00:00:00)
*先手優勢
**評価値=1118
**読み筋=△２四歩▲同　角△３六歩▲４五桂△同　銀▲３三角成△同　桂▲２一飛成△３七歩成▲６一角△４二金▲１一龍△４七と▲７二角成△同　銀▲７一金△５六銀
**深さ=15
  48 ３六歩打     ( 0:00/00:00:00)
*後手優勢
**評価値=-836
**読み筋=▲４五桂△３七歩成▲３三桂成
  49 ２三歩成(24) ( 0:00/00:00:00)
*先手勝勢
**評価値=1623
**読み筋=△３七歩成▲２九飛△２三金▲同　飛成△２二歩▲２六龍△４七と▲３四歩△４二角▲２二龍△６五歩▲同　銀△５八と▲７七角△９七角成▲４四角△２二飛▲同　角成
**深さ=15
  50 ３七歩成(36) ( 0:00/00:00:00)
*後手有利
**評価値=-524
**読み筋=▲３三と△２八と▲３二と
  51 ２九飛(28)   ( 0:00/00:00:00)
*先手勝勢
**評価値=1631
**読み筋=△２三金▲同　飛成△２二歩▲２六龍△４七と▲３四歩△５一角▲４三金△５八と▲７七角△２三歩▲４四金△６二角▲２三龍△４四角▲２一龍
**深さ=15
  52 ３八と(37)   ( 0:00/00:00:00)
*後手有利
**評価値=-524
**読み筋=▲３三と△２九と▲３二と
  53 ２六飛(29)   ( 0:00/00:00:00)
*先手勝勢
**評価値=1741
**読み筋=△２三金▲同　飛成△２二歩▲２七龍△４八と▲２八龍△６五歩▲３四歩△６六歩▲３三歩成△６七歩成▲同　金△３三銀▲４三角△６六歩▲同　金△４七と▲２一角成
**深さ=15
  54 ３四桂打     ( 0:00/00:00:00)
*互角
**評価値=-79
**読み筋=▲２五飛△２二角▲３二と
  55 ２五飛(26)   ( 0:01/00:00:01)
*先手勝勢
**評価値=2118
**読み筋=△１三桂▲同　と△同　香▲７五桂△７四銀▲１三角成△５一飛▲８六香△５五歩▲同　歩△６五歩▲７七銀引△７五銀▲同　歩△５五銀▲４五飛
**深さ=15
  56 ６五歩(64)   ( 0:00/00:00:00)
*互角
**評価値=127
**読み筋=▲６五銀△２二角▲３二と
  57 同　銀(66)   ( 0:01/00:00:02)
*先手勝勢
**評価値=2353
**読み筋=△１三桂▲同　角成△同　香▲３三と△同　銀▲２一飛成△２二金▲６一龍△６二飛▲同　龍△同　金▲７五桂△４九飛▲６三桂成△同　金▲６一角△６二金▲４三角成△１九飛成▲５四銀△１七龍
**深さ=15
  58 ２三金(32)   ( 0:00/00:00:00)
*互角
**評価値=80
**読み筋=▲２三飛成△６四歩▲３三龍
  59 同　飛成(25) ( 0:00/00:00:02)
*先手勝勢
**評価値=2281
**読み筋=△２二飛▲３四龍△２九飛成▲６四桂△同　銀▲同　銀△６三歩▲７五銀△４八と▲７七角△５五歩▲４三金△５六歩▲４四金△８五桂
**深さ=15
  60 ３六歩打     ( 0:00/00:00:00)
*先手優勢
**評価値=802
**読み筋=▲４三金△３七歩成▲５二金
  61 ２一龍(23)   ( 0:05/00:00:07)
*先手勝勢
**評価値=3381
**読み筋=△７四歩▲４三金△２二飛▲１一龍△２九飛成▲４一龍△１九龍▲４四金△同　角▲同　龍△９六香▲同　香△６九金▲５四銀△６八金▲同　金寄
**深さ=15
  62 ３七歩成(36) ( 0:00/00:00:00)
*先手優勢
**評価値=927
**読み筋=▲２三桂△１二飛▲３一桂成
  63 ７五桂打     ( 0:02/00:00:09)
*先手勝勢
**評価値=3708
**読み筋=△６二飛▲４三金△９二玉▲３三金△同　銀▲７一角△６一金▲６二角成△同　金上▲３二飛△４二角▲６三桂成△同　金直▲１一龍△４七と▲７一銀
**深さ=15
  64 ７四銀(63)   ( 0:00/00:00:00)
*先手有利
**評価値=450
**読み筋=▲６一龍△５一飛▲同　龍
  65 同　銀(65)   ( 0:03/00:00:12)
*先手勝勢
**評価値=3927
**読み筋=△７四歩▲７一銀△同　金▲８三桂成△同　玉▲７一龍△８二銀▲８一龍△６二飛▲４三金△９六桂▲同　香△４七と▲３三金△同　銀▲３五角△２二飛▲６一角△７二銀
**深さ=15
  66 同　歩(73)   ( 0:00/00:00:00)
*先手有望
**評価値=389
**読み筋=▲４三銀△５一飛▲同　龍
  67 ７一銀打     ( 0:09/00:00:21)
*先手勝勢
**評価値=4111
**読み筋=△７一金▲８三桂成△同　玉▲７一龍△７三桂▲９一龍△９六桂▲同　香△８二銀▲８六香△８五銀▲同　香△同　桂▲６一龍△２二飛▲６三龍△７三香▲６四金△４七と
**深さ=15
  68 同　金(72)   ( 0:00/00:00:00)
*後手有望
**評価値=-396
**読み筋=▲８三桂成△同　玉▲７一龍
  69 ８三桂成(75) ( 0:09/00:00:30)
*先手勝勢
**評価値=4181
**読み筋=△８三玉▲７一龍△７三桂▲９一龍△９六桂▲同　香△８二銀▲８六香△８五銀▲同　香△同　桂▲６一龍△２二飛▲６三龍△７三香▲６四金△４七と
**深さ=13
  70 同　玉(82)   ( 0:00/00:00:00)
*後手有望
**評価値=-391
**読み筋=▲７一龍△５一飛▲同　龍
  71 ７一龍(21)   ( 0:09/00:00:39)
*先手勝勢
**評価値=4197
**読み筋=△４七と▲８一龍△７三玉▲４三金△７二銀▲６五桂△６四玉▲９一龍△２二飛▲３三金△同　銀▲６六香△４二銀▲１一龍△２八飛成
**深さ=12
  72 ８二飛(52)   ( 0:00/00:00:00)
*後手有望
**評価値=-346
**読み筋=▲２四歩△２七桂▲８二龍
  73 ８四金打     ( 0:00/00:00:39)
**詰み=先手勝ち:7手
**読み筋=△８四玉▲８二龍△８三銀▲８五金△同　玉
**深さ=3
  74 ９二玉(83)   ( 0:00/00:00:00)
*後手有望
**評価値=-245
**読み筋=▲７四金△２八と上▲８二龍
  75 ８三金打     ( 0:00/00:00:39)
**詰み=先手勝ち:5手
**読み筋=△８三飛▲同　金△同　玉
**深さ=1
  76 同　飛(82)   ( 0:00/00:00:00)
*互角
**評価値=109
**読み筋=▲８三金△同　玉▲８一龍
  77 同　金(84)   ( 0:00/00:00:39)
**詰み=先手勝ち:3手
**読み筋=△８三玉
**深さ=1
  78 同　玉(92)   ( 0:00/00:00:00)
**詰み=先手勝ち
**読み筋=▲８二飛
  79 ８二飛打     ( 0:00/00:00:39)
**詰み=先手勝ち:1手
**深さ=1
  80 投了         ( 0:00/00:00:00)
`,
      },
      {
        testData: "src/tests/testdata/jkf/sample05.jkf",
        expected: `# KIF形式棋譜ファイル Generated by Electron Shogi
手合割：平手
手数----指手---------消費時間--
   1 ２六歩(27)   ( 0:08/00:00:08)
   2 ８四歩(83)   ( 0:17/00:00:17)
   3 ２五歩(26)   (35:42/00:35:50)
   4 ８五歩(84)   ( 3:33/00:03:50)
   5 ７八金(69)   (42:21/01:18:11)
   6 ３二金(41)   ( 9:11/00:13:01)
   7 投了         (50:43/02:08:54)
`,
      },
    ];
    for (const testCase of testCases) {
      const data = fs.readFileSync(testCase.testData, "utf-8");
      const record = importJKFString(data) as Record;
      expect(record).toBeInstanceOf(Record);
      expect(exportKIF(record)).toBe(testCase.expected);
    }
  });

  it("exportJKF", () => {
    const testCases = [
      {
        testData: `
先手：振り飛車党
後手：オールラウンダー
開始日時：20世紀
終了日時：21世紀
戦型：三間飛車
備考：テスト
手合割：平手
   1 ７六歩(77)
   2 ３四歩(33)
   3 ７五歩(76)
   4 ８四歩(83)+
   5 ７八飛(28)
   6 ８五歩(84)+
   7 ４八玉(59)
   8 ６二銀(71)
   9 ３八玉(48)
変化：6手
   6 ６二銀(71)
   7 ６六歩(67)
変化：4手
   4 ５四歩(53)
   5 ６六歩(67)+
   6 ４二銀(31)
   7 ７八飛(28)
   8 ５三銀(42)
   9 ６八銀(79)
変化：5手
   5 ７八飛(28)
   6 ８八角成(22)
   7 同　銀(79)
   8 ４五角打`,
        expected: `{
  "header": { "先手": "振り飛車党", "後手": "オールラウンダー", "開始日時": "20世紀", "終了日時": "21世紀", "戦型": "三間飛車", "備考": "テスト" },
  "initial": { "preset": "HIRATE" },
  "moves": [
    {},
    {
      "move": { "piece": "FU", "to": { "x": 7, "y": 6 }, "from": { "x": 7, "y": 7 }, "color": 0 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    },
    {
      "move": { "piece": "FU", "to": { "x": 3, "y": 4 }, "from": { "x": 3, "y": 3 }, "color": 1 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    },
    {
      "move": { "piece": "FU", "to": { "x": 7, "y": 5 }, "from": { "x": 7, "y": 6 }, "color": 0 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    },
    {
      "move": { "piece": "FU", "to": { "x": 8, "y": 4 }, "from": { "x": 8, "y": 3 }, "color": 1 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } },
      "forks": [
        [
          {
            "move": { "piece": "FU", "to": { "x": 5, "y": 4 }, "from": { "x": 5, "y": 3 }, "color": 1 },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          },
          {
            "move": { "piece": "FU", "to": { "x": 6, "y": 6 }, "from": { "x": 6, "y": 7 }, "color": 0 },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } },
            "forks": [
              [
                {
                  "move": { "piece": "HI", "to": { "x": 7, "y": 8 }, "from": { "x": 2, "y": 8 }, "color": 0 },
                  "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
                },
                {
                  "move": { "piece": "KA", "to": { "x": 8, "y": 8 }, "promote": true, "from": { "x": 2, "y": 2 }, "color": 1, "capture": "KA" },
                  "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
                },
                {
                  "move": { "piece": "GI", "same": true, "from": { "x": 7, "y": 9 }, "color": 0, "to": { "x": 8, "y": 8 }, "capture": "UM" },
                  "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
                },
                {
                  "move": { "piece": "KA", "to": { "x": 4, "y": 5 }, "color": 1 },
                  "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
                }
              ]
            ]
          },
          {
            "move": { "piece": "GI", "to": { "x": 4, "y": 2 }, "from": { "x": 3, "y": 1 }, "color": 1 },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          },
          {
            "move": { "piece": "HI", "to": { "x": 7, "y": 8 }, "from": { "x": 2, "y": 8 }, "color": 0 },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          },
          {
            "move": { "piece": "GI", "to": { "x": 5, "y": 3 }, "from": { "x": 4, "y": 2 }, "color": 1 },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          },
          {
            "move": { "piece": "GI", "to": { "x": 6, "y": 8 }, "from": { "x": 7, "y": 9 }, "color": 0 },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ]
      ]
    },
    {
      "move": { "piece": "HI", "to": { "x": 7, "y": 8 }, "from": { "x": 2, "y": 8 }, "color": 0 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    },
    {
      "move": { "piece": "FU", "to": { "x": 8, "y": 5 }, "from": { "x": 8, "y": 4 }, "color": 1 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } },
      "forks": [
        [
          {
            "move": { "piece": "GI", "to": { "x": 6, "y": 2 }, "from": { "x": 7, "y": 1 }, "color": 1 },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          },
          {
            "move": { "piece": "FU", "to": { "x": 6, "y": 6 }, "from": { "x": 6, "y": 7 }, "color": 0 },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ]
      ]
    },
    {
      "move": { "piece": "OU", "to": { "x": 4, "y": 8 }, "from": { "x": 5, "y": 9 }, "color": 0 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    },
    {
      "move": { "piece": "GI", "to": { "x": 6, "y": 2 }, "from": { "x": 7, "y": 1 }, "color": 1 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    },
    {
      "move": { "piece": "OU", "to": { "x": 3, "y": 8 }, "from": { "x": 4, "y": 8 }, "color": 0 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    }
  ]
}`,
      },
      {
        testData: `手合割：六枚落ち
*六枚落ちの棋譜
   1 ３二金(41)
   2 ７六歩(77)
   3 ６二玉(51)
   4 ６六角(88)+
*9筋を攻める定跡
   5 ８二銀(71)
   6 ９六歩(97)
   7 ７二金(61)
   8 ９五歩(96)
   9 ８四歩(83)+
  10 同　角(66)
  11 ８三金(72)
  12 ６六角(84)
変化：9手
   9 ７四歩(73)
  10 ９四歩(95)
  11 同　歩(93)
  12 同　香(99)
  13 ７三銀(82)
変化：9手
   9 ６四歩(63)
  10 ５六歩(57)
変化：4手
   4 １六歩(17)
*1筋を攻める定跡
   5 ２二銀(31)
   6 １五歩(16)
   7 ７二金(61)
   8 １七香(19)`,
        expected: `{
  "header": {},
  "initial": { "preset": "6" },
  "moves": [
    {
      "comments": [
        "六枚落ちの棋譜"
      ]
    },
    {
      "move": { "piece": "KI", "to": { "x": 3, "y": 2 }, "from": { "x": 4, "y": 1 }, "color": 1 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    },
    {
      "move": { "piece": "FU", "to": { "x": 7, "y": 6 }, "from": { "x": 7, "y": 7 }, "color": 0 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    },
    {
      "move": { "piece": "OU", "to": { "x": 6, "y": 2 }, "from": { "x": 5, "y": 1 }, "color": 1 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    },
    {
      "comments": [ "9筋を攻める定跡" ],
      "move": { "piece": "KA", "to": { "x": 6, "y": 6 }, "from": { "x": 8, "y": 8 }, "color": 0 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } },
      "forks": [
        [
          {
            "comments": [ "1筋を攻める定跡" ],
            "move": { "piece": "FU", "to": { "x": 1, "y": 6 }, "from": { "x": 1, "y": 7 }, "color": 0 },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          },
          {
            "move": { "piece": "GI", "to": { "x": 2, "y": 2 }, "from": { "x": 3, "y": 1 }, "color": 1 },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          },
          {
            "move": { "piece": "FU", "to": { "x": 1, "y": 5 }, "from": { "x": 1, "y": 6 }, "color": 0 },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          },
          {
            "move": { "piece": "KI", "to": { "x": 7, "y": 2 }, "from": { "x": 6, "y": 1 }, "color": 1 },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          },
          {
            "move": { "piece": "KY", "to": { "x": 1, "y": 7 }, "from": { "x": 1, "y": 9 }, "color": 0 },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ]
      ]
    },
    {
      "move": { "piece": "GI", "to": { "x": 8, "y": 2 }, "from": { "x": 7, "y": 1 }, "color": 1 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    },
    {
      "move": { "piece": "FU", "to": { "x": 9, "y": 6 }, "from": { "x": 9, "y": 7 }, "color": 0 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    },
    {
      "move": { "piece": "KI", "to": { "x": 7, "y": 2 }, "from": { "x": 6, "y": 1 }, "color": 1 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    },
    {
      "move": { "piece": "FU", "to": { "x": 9, "y": 5 }, "from": { "x": 9, "y": 6 }, "color": 0 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    },
    {
      "move": { "piece": "FU", "to": { "x": 8, "y": 4 }, "from": { "x": 8, "y": 3 }, "color": 1 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } },
      "forks": [
        [
          {
            "move": { "piece": "FU", "to": { "x": 7, "y": 4 }, "from": { "x": 7, "y": 3 }, "color": 1 },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          },
          {
            "move": { "piece": "FU", "to": { "x": 9, "y": 4 }, "from": { "x": 9, "y": 5 }, "color": 0 },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          },
          {
            "move": { "piece": "FU", "same": true, "from": { "x": 9, "y": 3 }, "color": 1, "to": { "x": 9, "y": 4 }, "capture": "FU" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          },
          {
            "move": { "piece": "KY", "same": true, "from": { "x": 9, "y": 9 }, "color": 0, "to": { "x": 9, "y": 4 }, "capture": "FU" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          },
          {
            "move": { "piece": "GI", "to": { "x": 7, "y": 3 }, "from": { "x": 8, "y": 2 }, "color": 1 },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "FU", "to": { "x": 6, "y": 4 }, "from": { "x": 6, "y": 3 }, "color": 1 },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          },
          {
            "move": { "piece": "FU", "to": { "x": 5, "y": 6 }, "from": { "x": 5, "y": 7 }, "color": 0 },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ]
      ]
    },
    {
      "move": { "piece": "KA", "same": true, "from": { "x": 6, "y": 6 }, "color": 0, "to": { "x": 8, "y": 4 }, "capture": "FU" },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    },
    {
      "move": { "piece": "KI", "to": { "x": 8, "y": 3 }, "from": { "x": 7, "y": 2 }, "color": 1 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    },
    {
      "move": { "piece": "KA", "to": { "x": 6, "y": 6 }, "from": { "x": 8, "y": 4 }, "color": 0 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    }
  ]
}`,
      },
      {
        testData: `
  ９ ８ ７ ６ ５ ４ ３ ２ １
+---------------------------+
| 銀 ・ ・ ・ ・ ・ ・ ・ 金|一
| ・ ・ ・ ・ ・ ・ ・ 金 ・|二
| 銀 銀 銀 ・ ・ ・ ・ 金 金|三
| ・ ・ ・ ・ ・ ・ ・ ・ ・|四
|v馬v馬 ・vとvとvと ・ ・ ・|五
| ・ ・ ・vと ・vと ・ ・ ・|六
| 龍 ・ ・ ・vと ・ ・ ・ ・|七
| ・ ・ ・ ・ ・ ・ ・ ・ ・|八
| ・ 龍 ・ ・ ・ ・ 桂 ・ 桂|九
+---------------------------+
   1 １二金(11)
   2 ５六と(45)
変化：2手
   2 ５六と(46)
変化：2手
   2 ５六と(55)
変化：2手
   2 ５六と(57)
変化：2手
   2 ５六と(65)
変化：2手
   2 ５六と(66)
変化：2手
   2 ８四馬(85)
変化：2手
   2 ８四馬(95)
変化：2手
   2 ９六馬(85)
変化：2手
   2 ９六馬(95)
変化：1手
   1 １二金(13)
変化：1手
   1 １二金(22)
変化：1手
   1 １二金(23)
変化：1手
   1 ２一金(22)
変化：1手
   1 ２七桂(19)
変化：1手
   1 ２七桂(39)
変化：1手
   1 ６四銀(73)
変化：1手
   1 ８二銀成(73)
変化：1手
   1 ８二銀(73)
変化：1手
   1 ８二銀成(83)
変化：1手
   1 ８二銀成(93)
変化：1手
   1 ８二銀成(91)
変化：1手
   1 ８六龍(89)
変化：1手
   1 ８六龍(97)
変化：1手
   1 ８七龍(89)
変化：1手
   1 ８七龍(97)
変化：1手
   1 ８八龍(89)
変化：1手
   1 ８八龍(97)
変化：1手
   1 ９九龍(89)
変化：1手
   1 ９九龍(97)`,
        expected: `{
  "header": {},
  "initial": {
    "preset": "OTHER",
    "data": {
      "board": [
        [ { "color": 0, "kind": "KI" }, {}, { "color": 0, "kind": "KI" }, {}, {}, {}, {}, {}, { "color": 0, "kind": "KE" } ],
        [ {}, { "color": 0, "kind": "KI" }, { "color": 0, "kind": "KI" }, {}, {}, {}, {}, {}, {} ],
        [ {}, {}, {}, {}, {}, {}, {}, {}, { "color": 0, "kind": "KE" } ],
        [ {}, {}, {}, {}, { "color": 1, "kind": "TO" }, { "color": 1, "kind": "TO" }, {}, {}, {} ],
        [ {}, {}, {}, {}, { "color": 1, "kind": "TO" }, {}, { "color": 1, "kind": "TO" }, {}, {} ],
        [ {}, {}, {}, {}, { "color": 1, "kind": "TO" }, { "color": 1, "kind": "TO" }, {}, {}, {} ],
        [ {}, {}, { "color": 0, "kind": "GI" }, {}, {}, {}, {}, {}, {} ],
        [ {}, {}, { "color": 0, "kind": "GI" }, {}, { "color": 1, "kind": "UM" }, {}, {}, {}, { "color": 0, "kind": "RY" } ],
        [ { "color": 0, "kind": "GI" }, {}, { "color": 0, "kind": "GI" }, {}, { "color": 1, "kind": "UM" }, {}, { "color": 0, "kind": "RY" }, {}, {} ]
      ],
      "color": 0,
      "hands": [
        { "FU": 0, "KY": 0, "KE": 0, "GI": 0, "KI": 0, "KA": 0, "HI": 0 },
        { "FU": 0, "KY": 0, "KE": 0, "GI": 0, "KI": 0, "KA": 0, "HI": 0 }
      ]
    }
  },
  "moves": [
    {},
    {
      "move": { "piece": "KI", "to": { "x": 1, "y": 2 }, "from": { "x": 1, "y": 1 }, "color": 0, "relative": "D" },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } },
      "forks": [
        [
          {
            "move": { "piece": "KI", "to": { "x": 1, "y": 2 }, "from": { "x": 1, "y": 3 }, "color": 0, "relative": "C" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "KI", "to": { "x": 1, "y": 2 }, "from": { "x": 2, "y": 2 }, "color": 0, "relative": "M" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "KI", "to": { "x": 1, "y": 2 }, "from": { "x": 2, "y": 3 }, "color": 0, "relative": "LU" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "KI", "to": { "x": 2, "y": 1 }, "from": { "x": 2, "y": 2 }, "color": 0, "relative": "U" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "KE", "to": { "x": 2, "y": 7 }, "from": { "x": 1, "y": 9 }, "color": 0, "relative": "R" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "KE", "to": { "x": 2, "y": 7 }, "from": { "x": 3, "y": 9 }, "color": 0, "relative": "L" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "GI", "to": { "x": 6, "y": 4 }, "from": { "x": 7, "y": 3 }, "color": 0, "promote": false },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "GI", "to": { "x": 8, "y": 2 }, "promote": true, "from": { "x": 7, "y": 3 }, "color": 0, "relative": "R" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "GI", "to": { "x": 8, "y": 2 }, "from": { "x": 7, "y": 3 }, "color": 0, "promote": false, "relative": "R" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "GI", "to": { "x": 8, "y": 2 }, "promote": true, "from": { "x": 8, "y": 3 }, "color": 0, "relative": "C" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "GI", "to": { "x": 8, "y": 2 }, "promote": true, "from": { "x": 9, "y": 3 }, "color": 0, "relative": "LU" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "GI", "to": { "x": 8, "y": 2 }, "promote": true, "from": { "x": 9, "y": 1 }, "color": 0, "relative": "D" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 }
            }
          }
        ],
        [
          {
            "move": { "piece": "RY", "to": { "x": 8, "y": 6 }, "from": { "x": 8, "y": 9 }, "color": 0, "relative": "R" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "RY", "to": { "x": 8, "y": 6 }, "from": { "x": 9, "y": 7 }, "color": 0, "relative": "L" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "RY", "to": { "x": 8, "y": 7 }, "from": { "x": 8, "y": 9 }, "color": 0, "relative": "U" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "RY", "to": { "x": 8, "y": 7 }, "from": { "x": 9, "y": 7 }, "color": 0, "relative": "M" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "RY", "to": { "x": 8, "y": 8 }, "from": { "x": 8, "y": 9 }, "color": 0, "relative": "U" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "RY", "to": { "x": 8, "y": 8 }, "from": { "x": 9, "y": 7 }, "color": 0, "relative": "D" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "RY", "to": { "x": 9, "y": 9 }, "from": { "x": 8, "y": 9 }, "color": 0, "relative": "M" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "RY", "to": { "x": 9, "y": 9 }, "from": { "x": 9, "y": 7 }, "color": 0, "relative": "D" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ]
      ]
    },
    {
      "move": { "piece": "TO", "to": { "x": 5, "y": 6 }, "from": { "x": 4, "y": 5 }, "color": 1, "relative": "LU" },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } },
      "forks": [
        [
          {
            "move": { "piece": "TO", "to": { "x": 5, "y": 6 }, "from": { "x": 4, "y": 6 }, "color": 1, "relative": "LM" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "TO", "to": { "x": 5, "y": 6 }, "from": { "x": 5, "y": 5 }, "color": 1, "relative": "C" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "TO", "to": { "x": 5, "y": 6 }, "from": { "x": 5, "y": 7 }, "color": 1, "relative": "D" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "TO", "to": { "x": 5, "y": 6 }, "from": { "x": 6, "y": 5 }, "color": 1, "relative": "RU" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 }
            }
          }
        ],
        [
          {
            "move": { "piece": "TO", "to": { "x": 5, "y": 6 }, "from": { "x": 6, "y": 6 }, "color": 1, "relative": "RM" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "UM", "to": { "x": 8, "y": 4 }, "from": { "x": 8, "y": 5 }, "color": 1, "relative": "L" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "UM", "to": { "x": 8, "y": 4 }, "from": { "x": 9, "y": 5 }, "color": 1, "relative": "R" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "UM", "to": { "x": 9, "y": 6 }, "from": { "x": 8, "y": 5 }, "color": 1, "relative": "L" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "UM", "to": { "x": 9, "y": 6 }, "from": { "x": 9, "y": 5 }, "color": 1, "relative": "R" },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ]
      ]
    }
  ]
}`,
      },
      {
        testData: `手合割：平手
*特殊な指し手のテスト
   1 ２六歩(27)
   2 ３四歩(33)
   3 ７六歩(77)
   4 中断
変化：4手
   4 投了
変化：4手
   4 持将棋
変化：4手
   4 千日手
変化：4手
   4 反則勝ち
変化：4手
   4 ５四歩(53)
   5 持将棋
変化：5手
   5 反則負け`,
        expected: `{
  "header": {},
  "initial": { "preset": "HIRATE" },
  "moves": [
    {
      "comments": [ "特殊な指し手のテスト" ]
    },
    {
      "move": { "piece": "FU", "to": { "x": 2, "y": 6 }, "from": { "x": 2, "y": 7 }, "color": 0 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    },
    {
      "move": { "piece": "FU", "to": { "x": 3, "y": 4 }, "from": { "x": 3, "y": 3 }, "color": 1 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    },
    {
      "move": { "piece": "FU", "to": { "x": 7, "y": 6 }, "from": { "x": 7, "y": 7 }, "color": 0 },
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
    },
    {
      "special": "CHUDAN",
      "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } },
      "forks": [
        [
          {
            "special": "TORYO",
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "special": "JISHOGI",
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "special": "SENNICHITE",
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "special": "+ILLEGAL_ACTION",
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          }
        ],
        [
          {
            "move": { "piece": "FU", "to": { "x": 5, "y": 4 }, "from": { "x": 5, "y": 3 }, "color": 1 },
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
          },
          {
            "special": "JISHOGI",
            "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } },
            "forks": [
              [
                {
                  "special": "ILLEGAL_MOVE",
                  "time": { "now": { "m": 0, "s": 0 }, "total": { "h": 0, "m": 0, "s": 0 } }
                }
              ]
            ]
          }
        ]
      ]
    }
  ]
}`,
      },
      {
        testData: `手合割：平手
   1 ２六歩(27)   ( 0:08/00:00:08)
   2 ８四歩(83)   ( 0:17/00:00:17)
   3 ２五歩(26)   (35:42/00:35:50)
   4 ８五歩(84)   ( 3:33/00:03:50)
   5 ７八金(69)   (42:21/01:18:11)
   6 ３二金(41)   ( 9:11/00:13:01)
   7 投了         (50:43/02:08:54)`,
        expected: `{
  "header": {},
  "initial": { "preset": "HIRATE" },
  "moves": [
    {},
    {
      "move": { "piece": "FU", "to": { "x": 2, "y": 6 }, "from": { "x": 2, "y": 7 }, "color": 0 },
      "time": { "now": { "m": 0, "s": 8 }, "total": { "h": 0, "m": 0, "s": 8 } }
    },
    {
      "move": { "piece": "FU", "to": { "x": 8, "y": 4 }, "from": { "x": 8, "y": 3 }, "color": 1 },
      "time": { "now": { "m": 0, "s": 17 }, "total": { "h": 0, "m": 0, "s": 17 } }
    },
    {
      "move": { "piece": "FU", "to": { "x": 2, "y": 5 }, "from": { "x": 2, "y": 6 }, "color": 0 },
      "time": { "now": { "m": 35, "s": 42 }, "total": { "h": 0, "m": 35, "s": 50 } }
    },
    {
      "move": { "piece": "FU", "to": { "x": 8, "y": 5 }, "from": { "x": 8, "y": 4 }, "color": 1 },
      "time": { "now": { "m": 3, "s": 33 }, "total": { "h": 0, "m": 3, "s": 50 } }
    },
    {
      "move": { "piece": "KI", "to": { "x": 7, "y": 8 }, "from": { "x": 6, "y": 9 }, "color": 0 },
      "time": { "now": { "m": 42, "s": 21 }, "total": { "h": 1, "m": 18, "s": 11 } }
    },
    {
      "move": { "piece": "KI", "to": { "x": 3, "y": 2 }, "from": { "x": 4, "y": 1 }, "color": 1 },
      "time": { "now": { "m": 9, "s": 11 }, "total": { "h": 0, "m": 13, "s": 1 } }
    },
    {
      "special": "TORYO",
      "time": { "now": { "m": 50, "s": 43 }, "total": { "h": 2, "m": 8, "s": 54 } }
    }
  ]
}`,
      },
    ];
    for (const testCase of testCases) {
      const record = importKIF(testCase.testData) as Record;
      const jkf = exportJKF(record);
      expect(jkf).toStrictEqual(JSON.parse(testCase.expected));
    }
  });
});
